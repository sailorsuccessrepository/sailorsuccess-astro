---
import BaseLayout from '../layouts/BaseLayout.astro';
import PagefindSearch from '../components/PagefindSearch.astro';
---

<BaseLayout 
  title="Search Encyclopedia - Sailor Success"
  description="Search through 180+ articles on merchant navy careers, exams, salary, rights, and tools."
>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        üîç Search Encyclopedia
      </h1>
      <p class="text-xl text-gray-600 dark:text-gray-300">
        Search through <strong>180+ articles</strong> on careers, exams, salary, rights, and tools
      </p>
    </div>

    <div class="max-w-3xl mx-auto">
      <form id="search-form" method="get" class="mb-6">
        <input id="search-input" name="q" placeholder="Search articles (title, description, tags)" class="w-full border rounded px-4 py-3" />
      </form>

      <div id="search-results" class="mt-4"></div>

      <div id="search-fallback" class="mt-4">
        <PagefindSearch />
      </div>
    </div>

    <div class="mt-12 max-w-3xl mx-auto">
      <h2 class="text-2xl font-bold mb-4 text-center">üî• Popular Searches</h2>
      <div class="flex flex-wrap justify-center gap-3">
        <button class="popular-search px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition" data-query="IMU CET">IMU CET</button>
        <button class="popular-search px-4 py-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition" data-query="sponsorship">Sponsorship</button>
        <button class="popular-search px-4 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition" data-query="salary">Salary</button>
        <button class="popular-search px-4 py-2 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition" data-query="deck officer">Deck Officer</button>
        <button class="popular-search px-4 py-2 bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-200 rounded-lg hover:bg-pink-200 dark:hover:bg-pink-800 transition" data-query="CDC">CDC</button>
        <button class="popular-search px-4 py-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-800 transition" data-query="medical fitness">Medical Fitness</button>
        <button class="popular-search px-4 py-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition" data-query="STCW">STCW</button>
        <button class="popular-search px-4 py-2 bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200 rounded-lg hover:bg-teal-200 dark:hover:bg-teal-800 transition" data-query="DG Shipping">DG Shipping</button>
      </div>
    </div>

    <div class="mt-12 text-center">
      <h2 class="text-2xl font-bold mb-4">üìö Browse by Category</h2>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="/careers/" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">üß≠ Careers</a>
        <a href="/learn/" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">üìö Learn</a>
        <a href="/money/" class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">üí∞ Money</a>
        <a href="/rights/" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">‚öñÔ∏è Rights</a>
        <a href="/tools/" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">üîß Tools</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const buttons = document.querySelectorAll('.popular-search');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const query = button.getAttribute('data-query') || '';
          const input = document.getElementById('search-input') as HTMLInputElement | null;
          if (input) {
            input.value = query;
            input.form?.dispatchEvent(new Event('submit', { bubbles: true }));
          }
        });
      });
    });

    // Client-side search using server API
    (function(){
      const params = new URL(location.href).searchParams;
      const q = params.get('q') || '';
      const input = document.getElementById('search-input') as HTMLInputElement | null;
      const resultsEl = document.getElementById('search-results') as HTMLElement | null;
      const fallback = document.getElementById('search-fallback') as HTMLElement | null;
      if (input) input.value = q;

      async function doSearch(term: string){
        if (!term) {
          if (resultsEl) resultsEl.innerHTML = '';
          if (fallback) fallback.style.display = '';
          return;
        }
        if (fallback) fallback.style.display = 'none';
        if (resultsEl) resultsEl.innerHTML = '<p class="text-sm text-gray-600">Searching‚Ä¶</p>';
        try{
          const res = await fetch(`/api/search.json?q=${encodeURIComponent(term)}`);
          const data = await res.json();
          if (!data || data.length === 0) {
            if (resultsEl) resultsEl.innerHTML = `<p class="text-sm text-gray-600">No results for "${term}".</p>`;
            return;
          }
          if (resultsEl) resultsEl.innerHTML = data.map((r:any)=>`<div class="p-3 border rounded mb-3"><a class="font-semibold text-lg" href="/${r.collection}/${r.slug}/">${r.title}</a><div class="text-sm text-gray-500">${r.category||''}</div><p class="text-sm text-gray-700 mt-2">${r.excerpt||''}</p></div>`).join('');
        }catch(e){
          if (resultsEl) resultsEl.innerHTML = '<p class="text-sm text-red-600">Search failed.</p>';
        }
      }

      const form = document.getElementById('search-form') as HTMLFormElement | null;
      form?.addEventListener('submit', (ev)=>{
        ev.preventDefault();
        const term = (document.getElementById('search-input') as HTMLInputElement).value.trim();
        history.replaceState({}, '', `/search/?q=${encodeURIComponent(term)}`);
        doSearch(term);
      });

      if (q) doSearch(q);
    })();
  </script>
</BaseLayout>
