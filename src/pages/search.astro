---
import BaseLayout from '../layouts/BaseLayout.astro';
import PagefindSearch from '../components/PagefindSearch.astro';
---

<BaseLayout 
  title="Search Encyclopedia - Sailor Success"
  description="Search through 180+ articles on merchant navy careers, exams, salary, rights, and tools."
>
  <div class="max-w-6xl mx-auto px-4 py-12">
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        ğŸ” Search Encyclopedia
      </h1>
      <p class="text-xl text-gray-600 dark:text-gray-300">
        Search through <strong>180+ articles</strong> on careers, exams, salary, rights, and tools
      </p>
    </div>

    <div class="max-w-3xl mx-auto">
      <form id="search-form" method="get" class="mb-6">
        <input id="search-input" name="q" placeholder="Search articles (title, description, tags)" class="w-full border rounded px-4 py-3" />
      </form>

      <div id="search-results" class="mt-4"></div>

      <div id="search-fallback" class="mt-4">
        <PagefindSearch />
      </div>
    </div>

    <div class="mt-12 max-w-3xl mx-auto">
      <h2 class="text-2xl font-bold mb-4 text-center">ğŸ”¥ Popular Searches</h2>
      <div class="flex flex-wrap justify-center gap-3">
        <button class="popular-search px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition" data-query="IMU CET">IMU CET</button>
        <button class="popular-search px-4 py-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition" data-query="sponsorship">Sponsorship</button>
        <button class="popular-search px-4 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition" data-query="salary">Salary</button>
        <button class="popular-search px-4 py-2 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition" data-query="deck officer">Deck Officer</button>
        <button class="popular-search px-4 py-2 bg-pink-100 dark:bg-pink-900 text-pink-800 dark:text-pink-200 rounded-lg hover:bg-pink-200 dark:hover:bg-pink-800 transition" data-query="CDC">CDC</button>
        <button class="popular-search px-4 py-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-800 transition" data-query="medical fitness">Medical Fitness</button>
        <button class="popular-search px-4 py-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition" data-query="STCW">STCW</button>
        <button class="popular-search px-4 py-2 bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200 rounded-lg hover:bg-teal-200 dark:hover:bg-teal-800 transition" data-query="DG Shipping">DG Shipping</button>
      </div>
    </div>

    <div class="mt-12 text-center">
      <h2 class="text-2xl font-bold mb-4">ğŸ“š Browse by Category</h2>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="/careers/" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">ğŸ§­ Careers</a>
        <a href="/learn/" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">ğŸ“š Learn</a>
        <a href="/money/" class="px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">ğŸ’° Money</a>
        <a href="/rights/" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">âš–ï¸ Rights</a>
        <a href="/tools/" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">ğŸ”§ Tools</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const buttons = document.querySelectorAll('.popular-search');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const query = button.getAttribute('data-query') || '';
          const input = document.getElementById('search-input') as HTMLInputElement | null;
          if (input) {
            input.value = query;
            input.form?.dispatchEvent(new Event('submit', { bubbles: true }));
          }
        });
      });
    });

    // Client-side search using server API
    (function(){
      const params = new URL(location.href).searchParams;
      const q = params.get('q') || '';
      const input = document.getElementById('search-input') as HTMLInputElement | null;
      const resultsEl = document.getElementById('search-results') as HTMLElement | null;
      const fallback = document.getElementById('search-fallback') as HTMLElement | null;
      if (input) input.value = q;

      async function doSearch(term: string){
        if (!term) {
          if (resultsEl) resultsEl.innerHTML = '';
          if (fallback) fallback.style.display = '';
          return;
        }
        if (fallback) fallback.style.display = 'none';
        if (resultsEl) resultsEl.innerHTML = '<p class="text-sm text-gray-600">Searchingâ€¦</p>';
        try{
          const res = await fetch(`/api/search.json?q=${encodeURIComponent(term)}`);
          const data = await res.json();
          if (!data || data.length === 0) {
            if (resultsEl) resultsEl.innerHTML = `\n              <div class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border">\n                <p class="text-lg font-semibold mb-2">No results found for "${term}".</p>\n                <p class="text-sm text-gray-600 mb-4">Try browsing the top categories:</p>\n                <div class=\"flex flex-wrap gap-2\">\n                  <a href=\"/careers/\" class=\"px-4 py-2 bg-blue-600 text-white rounded\">ğŸ§­ Careers</a>\n                  <a href=\"/learn/\" class=\"px-4 py-2 bg-green-600 text-white rounded\">ğŸ“š Learn</a>\n                  <a href=\"/money/\" class=\"px-4 py-2 bg-yellow-600 text-white rounded\">ğŸ’° Money</a>\n                  <a href=\"/rights/\" class=\"px-4 py-2 bg-purple-600 text-white rounded\">âš–ï¸ Rights</a>\n                  <a href=\"/tools/\" class=\"px-4 py-2 bg-gray-600 text-white rounded\">ğŸ”§ Tools</a>\n                </div>\n              </div>`;
            return;
          }

          // Render result cards
          const html = data.map((r:any) => {
            const category = r.category ? `<span class="text-xs font-medium text-gray-600 dark:text-gray-300">${r.category}</span>` : '';
            const tags = (r.tags || []).slice(0,6).map((t:string) => `<a href="/search/?q=${encodeURIComponent(t)}" class="inline-block text-xs px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-full mr-2 mb-2">${t}</a>`).join('');
            return `\n              <article class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border mb-4">\n                <a href="/${r.collection}/${r.slug}/" class="no-underline">\n                  <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-1">${r.title || ''}</h3>\n                </a>\n                <div class="flex items-center gap-3 mb-2">${category}</div>\n                <p class="text-sm text-gray-600 dark:text-gray-300 mb-3 line-clamp-2">${r.excerpt || ''}</p>\n                <div class=\"flex flex-wrap\">${tags}</div>\n              </article>`;
          }).join('');

          if (resultsEl) resultsEl.innerHTML = html;
        }catch(e){
          if (resultsEl) resultsEl.innerHTML = '<p class="text-sm text-red-600">Search failed.</p>';
        }
      }

      const form = document.getElementById('search-form') as HTMLFormElement | null;
      form?.addEventListener('submit', (ev)=>{
        ev.preventDefault();
        const term = (document.getElementById('search-input') as HTMLInputElement).value.trim();
        history.replaceState({}, '', `/search/?q=${encodeURIComponent(term)}`);
        doSearch(term);
      });

      if (q) doSearch(q);
    })();
  </script>
</BaseLayout>
